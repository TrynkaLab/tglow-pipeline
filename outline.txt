
*** = will require extra copy of data in one or all channels, at least temporarily


# Fetches raw data from NFS and recodes into new OME file structure
# imaging queue
process fetch_raw {
    input:
        path/to/index.xml
    output:
        data in ome stacks
}


# Illumination learning
# GPU
# Needs full plate
process run_basicpy {
    
    input:
        (path - plate 1 [,path - plate n])
        channels
        subsampling
        [plane]
        [field]
        [well]

    output:
        flatfields per channel
}


# Deconvolute images ***
# GPU
# context agnositic
process run_redlionfish {

    input:
        psf for each channel
        well
        path
    
    output:
        decon images for well
    
}

# Register plates against eachother
# CPU
# depends on plate n
process run_pystackreg {

    input:
        well
        (path 1 - cycle 1 [], path n - cycle n)
        registration channels
        save images / save registration
    
    output:
        registered images for well in one ome stack
        or
        registration matrices

}

# Run cellpose in 3d ***
# GPU
process run_cellpose {

    input:
        well
        path
        estimated cellsize
    
    output:
        masks in ome stack
}

# Convert data from OME stack to cellprofiler compatible format ***
# CPU
proccess prep_cellprofiler {

    input:
        well
        path
        2d/3d
        [flatfields]
        [registration matrices]
        
    output:
        either one ZYX .tiff per channel with all z-planes (3d)
        or     one CYX .tiff per field with each channel max projected as one stack (2d) 
    
}

# Run cellprofiler with the predefined masks
# CPU
process run_cellprofiler {

    input:
        output from prep_cellprofiler
        output from run_cellpose
    
    output:
        cp features

}
